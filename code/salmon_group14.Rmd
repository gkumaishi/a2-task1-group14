---
title: "Assignment 2 Task 1"
author: "Grace Kumaishi, Kaley Dodson, Quin Smith"
date: "1/31/2021"
output: 
  html_document:
    theme: cerulean
    code_folding: hide
runtime: shiny
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(tidyverse)
library(shiny)
library(here)
library(janitor)
library(lubridate)
library(tsibble)
library(feasts)
library(slider)
library(patchwork)
library(RColorBrewer)

# read in data (new way with pivot_longer())
willamette_fish <- read.csv(here("data", "willamette_fish_passage.csv")) %>% 
  clean_names() %>% 
  pivot_longer(
    cols = c(steelhead, coho, jack_coho),
    names_to = "species",
    values_to = "fish_count"
  )

#old way
willamette_fish2 <- read.csv(here("data", "willamette_fish_passage.csv")) %>% 
  clean_names()
```

## Overview {.tabset}

#### Fish ladder location:
![Salmon, Image Source: Portland General Electric](http://www.cbr.washington.edu/img/hydro/willamette_falls.jpg)

- An engaging image (with caption, including photo credit) that is relevant to the dataset
- A brief summary (3 - 4 sentences) of the dataset, and what is included in this “report”
- A map of the fish ladder location (you can make this in R on your own, or include an existing map appropriately licensed, with attribution)
- A professionally formatted data citation
- Remember: All code that you used to wrangle the data and prepare the graphs should be available to see if we click on the Code buttons. 

#### Summary:

#### Citation: 
Data shared by and accessed from [Columbia River DART](http://www.cbr.washington.edu/dart/query/adult_graph_text). Data Courtesy of [U.S. Army Corps of Engineers, NWD](https://www.nwd.usace.army.mil/) and [Chelan](https://www.chelanpud.org/), [Douglas](https://douglaspud.org/), and [Grant](https://www.grantpud.org/) County PUDs, [Yakima Klickitat Fisheries Project](http://www.ykfp.org/), [Colville Tribes Fish & Wildlife (OBMEP)](http://nrd.colvilletribes.com/obmep/), [Oregon Department of Fish & Wildlife](https://www.dfw.state.or.us/), [Washington Department of Fish & Wildlife](https://wdfw.wa.gov/).

```{r}
#data wrangling, turn dataset into a tsibble (new way with pivot_longer())

fish_ts <- willamette_fish %>% 
  mutate(date = mdy(date)) %>% # converts date to y-m-d format
  as_tsibble(key = species, index = date) %>% # converts data to tsibble
  select(date, species, fish_count) %>% # retains only date, species, and fish_count variables
  mutate(species_name = case_when(
    species == "coho" ~ "Coho",
    species == "jack_coho" ~ "Jack Coho",
    species == "steelhead" ~ "Steelhead"
  )) # creates new column with species' full names
  
#old way
fish_ts2 <- willamette_fish2 %>% 
  mutate(date = mdy(date)) %>% 
  as_tsibble(key = NULL, index = date)

```


### Time series

```{r, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 8}
#time series plot of adult passage for coho, jack coho, and steelhead (new way with pivot_longer())

fish_tsplot <- fish_ts %>%
  replace_na(list(fish_count = 0))

ggplot(data = fish_tsplot, aes(x = date, y = fish_count, color = species)) +
  geom_line() +
  theme_bw()

#old way
fish_tsplot2 <- fish_ts2 %>%
  replace_na(list(coho = 0, jack_coho = 0, steelhead = 0))

coho_plot <- fish_tsplot2 %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = coho), color = "#317eb1") +
  labs(y = "Coho", x = "") +
  theme_bw()

jc_plot <- fish_tsplot2 %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = jack_coho), color = "#317eb1") +
  labs(y = "Jack coho", x = "") +
  theme_bw()

sh_plot <- fish_tsplot2 %>% 
  ggplot(aes(x = date)) +
  geom_line(aes(y = steelhead), color = "#317eb1") +
  labs(y = "Steelhead", x = "Year") +
  theme_bw()

comp_graph <- coho_plot / jc_plot / sh_plot
comp_graph

```  

### Seasonplots

```{r}
# Using pivot_longer() tidy dataset
fish_seasons <- fish_ts %>% 
  gg_season(y = fish_count) +
  facet_wrap(~species_name, ncol = 1, scales = "free") +
  labs(x = "Month", y = "Counts") +
  theme_bw()

fish_seasons

# Old way (delete?)
#coho_season <- fish_ts2 %>% 
  #gg_season(y = coho) +
  #labs(y = "Coho count",
       #x = "") +
  #theme_bw() +
  #theme(legend.position = "none") 

#jc_season <- fish_ts2 %>% 
  #gg_season(y = jack_coho) +
  #labs(y = "Jack Coho count",
       #x = "") +
  #theme_bw() 

#sh_season <- fish_ts2 %>% 
  #gg_season(y = steelhead) +
  #labs(y = "Steelhead count",
       #x = "Month") +
  #theme_bw() +
  #theme(legend.position = "none")

#combined <- coho_season / jc_season / sh_season
#combined
```

**Figure 1:** Three seasonplots showing trends for three anadromous fish species: Coho, Jack Coho, and Steelhead at the Willamette Falls fish ladder. Counts of individuals over the course of a year are shown, with each color corresponding to a different year of the study (Data: [Columbia River DART](http://www.cbr.washington.edu/dart/query/adult_graph_text)).

#### Notable trends:
- Coho and jack coho peak in October, and are virtually absent between December - August. 
- Steelhead show a wider variety in months present, peaking between May - July for most years. 

### Summary statistics and analysis

```{r, fig.cap="**Figure 3:** Annual salmon counts at the Willamette Falls fish ladder, vizualized by species. (Data: [Columbia River DART](http://www.cbr.washington.edu/dart/query/adult_graph_text)"}
# wrangling to aggregate fish counts by year
fish_annual <- fish_ts %>% 
  index_by(year = ~year(.)) %>% # groups observations by year
  group_by(species_name) %>% # groups observations by species
  summarize(total_count = sum(fish_count, na.rm = TRUE)) # counts observations per year by species

#vizualization of annual counts
ggplot(data = fish_annual, aes(x = year, y = total_count, fill = species_name, color = "black")) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~species_name, scales = "free") +
  theme_bw() +
  labs(x = "Year", y = "Individuals Observed") +
  scale_x_continuous(breaks = c(2002, 2004, 2006, 2008, 2010)) +
  theme(axis.text.x = element_text(angle = 30)) +
  scale_y_continuous(labels = scales::comma) +
  scale_fill_manual(values = rev(brewer.pal(3,"Oranges")))
```
#### Notable trends:
- Steelhead and are the most numerous species.
- Coho and Jack Coho numbers increased toward the end of the decade while Steelhead numbers declined somewhat.

